CREATE TABLE ADS_PRICE_HISTORY_V2 WITH (KAFKA_TOPIC='json-sr-price-change', PARTITIONS=3, REPLICAS=3, VALUE_FORMAT='JSON_SR') AS SELECT
  ADS.TOKEN TOKEN,
  AS_VALUE(ADS.TOKEN) TOKEN_VALUE,
  (LATEST_BY_OFFSET(ADS.PRICE, 2)[2] - LATEST_BY_OFFSET(ADS.PRICE, 2)[1]) PRICE_CHANGE,
  LATEST_BY_OFFSET(ADS.PRICE, 2)[1] PREV_PRICE,
  LATEST_BY_OFFSET(ADS.PRICE, 2)[2] CURRNET_PRICE,
  FORMAT_TIMESTAMP(FROM_UNIXTIME(UNIX_TIMESTAMP()), 'yyyy-MM-dd HH:mm:ss.SSS', 'UTC') ACTION_TIME
FROM ADS ADS
GROUP BY ADS.TOKEN
EMIT CHANGES;