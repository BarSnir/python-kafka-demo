CREATE TABLE TEST_V6 WITH (KAFKA_TOPIC='avro-price-change', PARTITIONS=1, REPLICAS=3, VALUE_FORMAT='JSON_SR') AS SELECT
  ADS.TOKEN TOKEN,
  AS_VALUE(ADS.TOKEN) TOKEN_VALUE,
  FORMAT_TIMESTAMP(FROM_UNIXTIME(UNIX_TIMESTAMP()), 'yyyy-MM-dd HH:mm:ss.SSS', 'UTC') ACTION_TIME,
  (COLLECT_LIST(ADS.PRICE)[ARRAY_LENGTH(COLLECT_LIST(ADS.PRICE))] - COLLECT_LIST(ADS.PRICE)[(ARRAY_LENGTH(COLLECT_LIST(ADS.PRICE)) - 1)]) PRICE_CHANGE
FROM ADS ADS
GROUP BY ADS.TOKEN
EMIT CHANGES;