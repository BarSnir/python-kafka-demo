CREATE TABLE ADS_PRICE_HISTORY WITH (KAFKA_TOPIC='json-sr-price-change', PARTITIONS=5, REPLICAS=3, VALUE_FORMAT='JSON_SR') AS SELECT
  WITH_PARTITIONS_BY.TOKEN TOKEN,
  AS_VALUE(WITH_PARTITIONS_BY.TOKEN) TOKEN_VALUE,
  FORMAT_TIMESTAMP(FROM_UNIXTIME(UNIX_TIMESTAMP()), 'yyyy-MM-dd HH:mm:ss.SSS', 'UTC') ACTION_TIME,
  (CASE WHEN (COUNT(WITH_PARTITIONS_BY.TOKEN) > 1) THEN (COLLECT_LIST(WITH_PARTITIONS_BY.PRICE)[ARRAY_LENGTH(COLLECT_LIST(WITH_PARTITIONS_BY.PRICE))] - COLLECT_LIST(WITH_PARTITIONS_BY.PRICE)[(ARRAY_LENGTH(COLLECT_LIST(WITH_PARTITIONS_BY.PRICE)) - 1)]) END) PRICE_CHANGE,
  COLLECT_LIST(WITH_PARTITIONS_BY.PRICE)[ARRAY_LENGTH(COLLECT_LIST(WITH_PARTITIONS_BY.PRICE))] CURRENT_PRICE,
  (CASE WHEN (COUNT(WITH_PARTITIONS_BY.TOKEN) > 1) THEN COLLECT_LIST(WITH_PARTITIONS_BY.PRICE)[(ARRAY_LENGTH(COLLECT_LIST(WITH_PARTITIONS_BY.PRICE)) - 1)] END) PREV_PRICE
FROM WITH_PARTITIONS_BY WITH_PARTITIONS_BY
GROUP BY WITH_PARTITIONS_BY.TOKEN
EMIT CHANGES;`